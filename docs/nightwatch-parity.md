# Percy Nightwatch Feature Gaps

This document compares the legacy `@percy/nightwatch` command implementation (`commands/percySnapshot.js`) with the modern `@percy/selenium-webdriver` SDK (`percy-selenium-js/index.js`). The goal is to capture every feature present in the Selenium SDK that is currently missing from the Nightwatch SDK so we can track parity work.

| #   | Feature / Capability                                                                                                                                                                      | Selenium Location                                             | Nightwatch Status | Notes                                                                                                                        | Implementation Summary |
| --- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------- | ---------------------- |
| 1   | Responsive multi-width DOM capture (`responsiveSnapshotCapture`, `widths`, `PercyDOM.waitForResize()`)                                                                                    | `captureResponsiveDOM`, `captureDOM`                          | **Implemented**   | `lib/snapshot.js` now mirrors the Selenium helpers and drives multi-width captures from Nightwatch.                          | Added `captureResponsiveDOM()` and wired `commands/percySnapshot.js` to delegate so widths/env toggles match Selenium. |
| 2   | Chrome DevTools Protocol resizing with fallback to WebDriver `setRect`, controlled by `PERCY_DISABLE_CDP_RESIZE`                                                                          | `changeWindowDimensionAndWait()`                              | **Implemented**   | Nightwatch attempts CDP resizing when running Chrome and falls back to WebDriver window APIs.                                | `changeWindowDimensionAndWait()` uses CDP via `driver.sendDevToolsCommand` with WebDriver fallbacks + resize waits. |
| 3   | Responsive-capture environment hooks (`PERCY_RESPONSIVE_CAPTURE_MIN_HEIGHT`, `PERCY_RESPONSIVE_CAPTURE_RELOAD_PAGE`, `RESPONSIVE_CAPTURE_SLEEP_TIME`, `PERCY_ENABLE_LAZY_LOADING_SCROLL`) | `captureResponsiveDOM()`                                      | **Implemented**   | All responsive env toggles are honored before each width, matching the Selenium SDK behavior.                                | Hooks added around each width: reloading + DOM reinjection, sleeps, lazy scrolls, and height adjustments. |
| 4   | Lazy-load scrolling helper (`slowScrollToBottom`) with env controls (`PERCY_LAZY_LOAD_SCROLL_TIME`, `PERCY_SLEEP_AFTER_LAZY_LOAD_COMPLETE`, `BYPASS_SCROLL_TO_TOP`)                       | `slowScrollToBottom()`                                        | **Implemented**   | `lib/snapshot.js` exports the lazy scroll helper and the responsive path invokes it when enabled.                             | Ported `slowScrollToBottom()` from Selenium SDK and call it when `PERCY_ENABLE_LAZY_LOADING_SCROLL` is set. |
| 5   | Ability to opt-in/out of canvas serialization errors via option/config (`ignoreCanvasSerializationErrors`)                                                                                | `ignoreCanvasSerializationErrors()`, `captureSerializedDOM()` | **Implemented**   | Snapshot options now pass the same serialization flags as Selenium, falling back to Percy config defaults.                   | Helper functions merge per-snapshot options with Percy config before calling `PercyDOM.serialize()`. |
| 6   | Ability to opt-in/out of stylesheet serialization errors (`ignoreStyleSheetSerializationErrors`)                                                                                          | `ignoreStyleSheetSerializationErrors()`                       | **Implemented**   | Style sheet serialization errors can be controlled per snapshot or via Percy config.                                         | Same helper approach as canvas errors; flags added to every `captureSerializedDOM()` call. |
| 7   | Automatic inclusion of browser cookies in DOM snapshot payloads                                                                                                                           | `captureSerializedDOM()`                                      | **Implemented**   | Nightwatch captures cookies via `browser.getCookies()` and attaches them to every DOM snapshot payload.                      | `captureSerializedDOM()` fetches cookies via command callbacks and appends them to serialized DOM. |
| 8   | Handling Percy Automate vs. Percy Visual (`utils.percy.type` guards). Snapshot disallows Automate sessions and `percyScreenshot()` handles Automate explicitly.                           | `percySnapshot()`, `percyScreenshot()`                        | **Missing**       | Nightwatch neither blocks Automate usage nor provides a `percyScreenshot` helper.                                            | TODO: add Automate guards + `percyScreenshot`. |
| 9   | raising errors when Percy isn't running when `PERCY_RAISE_ERROR=true`                                                                                                                     | `percySnapshot()`, env handling                               | **Implemented**   | Commands now throw when `PERCY_RAISE_ERROR=true` and Percy is disabled.                                                       | `commands/percySnapshot.js` checks `utils.isPercyEnabled()` / snapshot errors and rethrows under the env flag. |
| 10  | Region helper (`createRegion`) for building structured `regions` entries                                                                                                                  | `createRegion()`                                              | **Implemented**   | Helper exported via `commands/percySnapshot.js` and TypeScript defs.                                                         | New `lib/regions.js` + re-export + typings. |
| 11  | Automate screenshot flow (`percyScreenshot`, `DriverMetadata`, `Cache`, `request`)                                                                                                        | `percyScreenshot()`, `driverMetadata.js`, `cache.js`          | **Missing**       | Entire Automate API surface absent from Nightwatch.                                                                          | TODO. |
| 12  | Driver metadata caching / command executor discovery                                                                                                                                      | `DriverMetadata`, `Cache`                                     | **Missing**       | Not applicable today but required for Automate parity.                                                                       | TODO. |
| 13  | Type definitions that expose both `percySnapshot` and `percyScreenshot` plus richer option docs                                                                                           | `percy-selenium-js/types/index.d.ts`                          | **Partial**       | Nightwatch only extends the Nightwatch command typing and lacks Automate + helper definitions.                               | Types now include `createRegion` + enhanced snapshot options; Automate types pending. |
| 14  | Extensive automated test coverage (Jasmine suite covering responsive behavior, env toggles, helper utilities)                                                                             | `percy-selenium-js/test/*.mjs`                                | **In Progress**   | Nightwatch now has unit tests for helper modules plus example app coverage, but Automate paths still pending.                | Added mocha unit tests for helpers + Nightwatch responsive tests; more coverage planned around Automate/caching. |

## High-Level Implications

- Bringing Nightwatch to feature parity requires refactoring `commands/percySnapshot.js` into a richer module that mirrors the Selenium SDK architecture (helpers for DOM capture, responsive orchestration, error toggles, etc.).
- We need to expose both `percySnapshot()` (Nightwatch command) and an Automate-friendly `percyScreenshot()` entry point, including driver metadata utilities so BrowserStack Automate users can call Percy directly from Nightwatch tests.
- Configuration and per-snapshot option handling must honor the same option names as Selenium (e.g., `responsiveSnapshotCapture`, ignore flags, `regions`, etc.) to stay consistent with the source of truth.
- Test strategy must expand beyond the current Nightwatch integration tests to include unit-level coverage of new helpers and behaviors, similar to the Jasmine suite in `percy-selenium-js/test`.

This table will serve as the checklist while porting features from `@percy/selenium-webdriver` into `@percy/nightwatch`.
