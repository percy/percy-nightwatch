<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Features Test - Percy Nightwatch E2E</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    header h1 {
      color: #667eea;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .section h2 {
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #667eea;
    }

    /* Animated elements - should be frozen with Percy CSS */
    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .pulse-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      animation: pulse 2s infinite;
      margin: 20px 0;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }

    .fade-element {
      background: #ffd700;
      padding: 20px;
      border-radius: 8px;
      animation: fadeInOut 3s infinite;
      text-align: center;
      font-weight: bold;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Dynamic content that should be hidden */
    .dynamic-timestamp {
      background: #fffbea;
      border: 2px solid #f59e0b;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 1.3rem;
      color: #d97706;
    }

    .random-number {
      background: #fce7f3;
      border: 2px solid #ec4899;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
      font-size: 2rem;
      font-weight: bold;
      color: #ec4899;
    }

    /* Scoped sections */
    .scope-section-1 {
      background: #e0e7ff;
      border: 3px solid #667eea;
      padding: 30px;
      border-radius: 12px;
      margin: 20px 0;
    }

    .scope-section-2 {
      background: #fce7f3;
      border: 3px solid #ec4899;
      padding: 30px;
      border-radius: 12px;
      margin: 20px 0;
    }

    .scope-section-3 {
      background: #d1fae5;
      border: 3px solid #10b981;
      padding: 30px;
      border-radius: 12px;
      margin: 20px 0;
    }

    /* Invalid HTML tags */
    foo, bar, baz {
      display: block;
      background: #f3f4f6;
      padding: 15px;
      border-left: 4px solid #667eea;
      margin: 10px 0;
      border-radius: 4px;
    }

    .code-block {
      background: #2d3748;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
      margin: 15px 0;
    }

    .info-badge {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      margin: 5px;
    }

    iframe {
      width: 100%;
      height: 300px;
      border: 2px solid #667eea;
      border-radius: 8px;
    }

    .feature-list {
      list-style-position: inside;
      line-height: 2;
      color: #555;
    }

    .feature-list li {
      padding-left: 10px;
      border-left: 3px solid #667eea;
      margin-bottom: 10px;
      padding-top: 5px;
      padding-bottom: 5px;
      background: #f8f9fa;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ Advanced Features Test</h1>
      <p style="font-size: 1.1rem; margin-top: 10px; color: #666;">
        Testing Percy CSS, scope, DOM transformation, and shadow DOM
      </p>
      <div style="margin-top: 15px;">
        <span class="info-badge">Percy CSS</span>
        <span class="info-badge">Scope Selector</span>
        <span class="info-badge">DOM Transform</span>
        <span class="info-badge">Shadow DOM</span>
      </div>
    </header>

    <!-- Info Section -->
    <div class="section">
      <h2>üìã About This Test</h2>
      <p style="margin-bottom: 15px;">
        This page tests advanced Percy Nightwatch SDK features that control how
        snapshots are captured and processed.
      </p>
      <h3 style="color: #667eea; margin: 20px 0 10px 0;">Features Tested:</h3>
      <ul class="feature-list">
        <li><strong>percyCSS</strong> - Inject CSS to hide/freeze elements during snapshot</li>
        <li><strong>scope</strong> - Capture only a specific part of the page</li>
        <li><strong>domTransformation</strong> - Run JavaScript to transform DOM before capture</li>
        <li><strong>disableShadowDOM</strong> - Control shadow DOM serialization</li>
        <li><strong>enableJavaScript</strong> - Control JS execution during Percy render</li>
        <li><strong>reshuffleInvalidTags</strong> - Fix invalid HTML tags automatically</li>
      </ul>
    </div>

    <!-- Percy CSS Section -->
    <div class="section">
      <h2>üé® Percy CSS - Animation Freezing</h2>
      <p style="margin-bottom: 20px;">
        These elements have CSS animations that should be frozen using Percy CSS.
        Percy CSS allows you to inject custom styles during snapshot rendering.
      </p>

      <div class="spinner"></div>

      <div class="pulse-box">
        Pulsing Element (Should be frozen)
      </div>

      <div class="fade-element">
        Fading Element (Should be frozen)
      </div>

      <div class="dynamic-timestamp" data-percy-hide>
        Current Time: <span id="current-time">Loading...</span>
      </div>

      <div class="random-number" data-percy-hide>
        Random: <span id="random-value">Loading...</span>
      </div>

      <div class="code-block">
// Example Percy CSS to freeze animations and hide dynamic content
percyCSS: `
  * { animation: none !important; transition: none !important; }
  [data-percy-hide] { visibility: hidden !important; }
  .spinner { animation-play-state: paused !important; }
`
      </div>
    </div>

    <!-- Scope Selector Section -->
    <div class="section">
      <h2>üéØ Scope Selector - Partial Page Capture</h2>
      <p style="margin-bottom: 20px;">
        The <code>scope</code> option allows capturing only a specific portion of the page
        using a CSS selector. This is useful for component-level testing.
      </p>

      <div id="scope-section-1" class="scope-section-1">
        <h3 style="color: #667eea; margin-bottom: 15px;">Section 1 - Capture This</h3>
        <p style="line-height: 1.8;">
          This is the first scoped section. When using <code>scope: '#scope-section-1'</code>,
          only this section will be captured in the snapshot.
        </p>
        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
          <strong>Content inside scope-section-1</strong>
          <p>All nested content is included when parent is scoped.</p>
        </div>
      </div>

      <div id="scope-section-2" class="scope-section-2">
        <h3 style="color: #ec4899; margin-bottom: 15px;">Section 2 - Or This</h3>
        <p style="line-height: 1.8;">
          This is the second scoped section. Using <code>scope: '#scope-section-2'</code>
          would capture only this pink section.
        </p>
      </div>

      <div id="scope-section-3" class="scope-section-3">
        <h3 style="color: #10b981; margin-bottom: 15px;">Section 3 - Or This</h3>
        <p style="line-height: 1.8;">
          This is the third scoped section. You can test different scopes to verify
          Percy only captures the selected portion.
        </p>
      </div>

      <div class="code-block">
// Example scope usage
browser.percySnapshot('Scoped Snapshot', {
  scope: '#scope-section-1'  // Only captures section 1
});
      </div>
    </div>

    <!-- DOM Transformation Section -->
    <div class="section">
      <h2>üîß DOM Transformation</h2>
      <p style="margin-bottom: 20px;">
        The <code>domTransformation</code> option allows you to run JavaScript to modify
        the DOM before Percy captures it. This is useful for setting test data or hiding
        dynamic content.
      </p>

      <div id="transform-target" style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <p id="transform-text">Original text that can be transformed</p>
        <p id="transform-value">Value: <span class="value">0</span></p>
        <button id="transform-button" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Click Me
        </button>
      </div>

      <div class="code-block">
// Example DOM transformation
domTransformation: `
  document.getElementById('transform-text').textContent = 'Transformed!';
  document.querySelector('.value').textContent = '42';
  document.getElementById('transform-button').disabled = true;
`
      </div>
    </div>

    <!-- Shadow DOM Section -->
    <div class="section">
      <h2>üåì Shadow DOM Serialization</h2>
      <p style="margin-bottom: 20px;">
        Shadow DOM creates encapsulated component trees. The <code>disableShadowDOM</code>
        option controls whether Percy serializes shadow roots.
      </p>

      <advanced-component title="Component 1" color="#667eea">
        This content is inside a shadow DOM web component with encapsulated styles.
      </advanced-component>

      <advanced-component title="Component 2" color="#764ba2">
        Shadow DOM should be serialized by default, capturing all component internals.
      </advanced-component>

      <advanced-component title="Component 3" color="#10b981">
        Set <code>disableShadowDOM: true</code> to skip shadow DOM serialization.
      </advanced-component>

      <div class="code-block">
// Test with shadow DOM enabled (default)
browser.percySnapshot('With Shadow DOM');

// Test with shadow DOM disabled
browser.percySnapshot('Without Shadow DOM', {
  disableShadowDOM: true
});
      </div>
    </div>

    <!-- Invalid HTML Tags Section -->
    <div class="section">
      <h2>üî® Invalid HTML Tags - Reshuffle Test</h2>
      <p style="margin-bottom: 20px;">
        The <code>reshuffleInvalidTags</code> option automatically fixes invalid HTML
        during serialization. These custom tags are not standard HTML:
      </p>

      <foo>
        <strong>&lt;foo&gt; tag:</strong> This is an invalid HTML element that should be handled.
      </foo>

      <bar>
        <strong>&lt;bar&gt; tag:</strong> Another custom element for testing tag reshuffling.
      </bar>

      <baz>
        <strong>&lt;baz&gt; tag:</strong> Percy can normalize these during serialization.
      </baz>

      <div class="code-block">
// Test with tag reshuffling
browser.percySnapshot('Reshuffled Tags', {
  reshuffleInvalidTags: true
});
      </div>
    </div>

    <!-- Nested iframes Section -->
    <div class="section">
      <h2>üñºÔ∏è Nested iframes</h2>
      <p style="margin-bottom: 20px;">
        Testing iframe serialization within the page. Percy should capture iframe content
        when accessible.
      </p>

      <iframe id="test-iframe" srcdoc="<html><body style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: Arial; display: flex; align-items: center; justify-content: center; height: 100%; margin: 0;'><h1>Iframe Content</h1><p>This is inside an iframe</p></body></html>">
      </iframe>
    </div>

    <!-- Testing Instructions -->
    <div class="section">
      <h2>üß™ Testing Instructions</h2>

      <h3 style="color: #667eea; margin: 20px 0 10px 0;">Percy CSS Tests:</h3>
      <ul class="feature-list">
        <li>Snapshot without Percy CSS - animations visible</li>
        <li>Snapshot with Percy CSS - animations frozen, dynamic content hidden</li>
        <li>Verify spinner, pulse, and fade effects are stable</li>
      </ul>

      <h3 style="color: #667eea; margin: 20px 0 10px 0;">Scope Tests:</h3>
      <ul class="feature-list">
        <li>Full page snapshot (no scope)</li>
        <li>Scoped to section 1: <code>scope: '#scope-section-1'</code></li>
        <li>Scoped to section 2: <code>scope: '#scope-section-2'</code></li>
        <li>Verify only selected section is captured</li>
      </ul>

      <h3 style="color: #667eea; margin: 20px 0 10px 0;">DOM Transformation Tests:</h3>
      <ul class="feature-list">
        <li>Snapshot without transformation - original content</li>
        <li>Snapshot with transformation - modified content</li>
        <li>Verify DOM changes are applied before capture</li>
      </ul>

      <h3 style="color: #667eea; margin: 20px 0 10px 0;">Shadow DOM Tests:</h3>
      <ul class="feature-list">
        <li>Snapshot with shadow DOM enabled (default)</li>
        <li>Snapshot with <code>disableShadowDOM: true</code></li>
        <li>Compare captured content differences</li>
      </ul>
    </div>
  </div>

  <!-- Shadow DOM Custom Element Template -->
  <template id="advanced-component-template">
    <style>
      :host {
        display: block;
        margin: 20px 0;
      }
      .component {
        background: white;
        border: 4px solid var(--component-color, #667eea);
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .component-header {
        background: var(--component-color, #667eea);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 1.3rem;
        font-weight: bold;
      }
      .component-content {
        color: #555;
        line-height: 1.8;
        padding: 10px;
      }
      .shadow-badge {
        display: inline-block;
        background: var(--component-color, #667eea);
        color: white;
        padding: 6px 14px;
        border-radius: 15px;
        font-size: 0.85rem;
        margin-top: 12px;
      }
    </style>
    <div class="component">
      <div class="component-header"></div>
      <div class="component-content">
        <slot></slot>
      </div>
      <div class="shadow-badge">‚ö° Shadow DOM Component</div>
    </div>
  </template>

  <script>
    // Register advanced web component with Shadow DOM
    class AdvancedComponent extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
      }

      connectedCallback() {
        const template = document.getElementById('advanced-component-template');
        const content = template.content.cloneNode(true);

        const title = this.getAttribute('title') || 'Advanced Component';
        const color = this.getAttribute('color') || '#667eea';

        content.querySelector('.component-header').textContent = title;
        content.querySelector('.component').style.setProperty('--component-color', color);

        this.shadowRoot.appendChild(content);
      }
    }
    customElements.define('advanced-component', AdvancedComponent);

    // Update dynamic timestamp
    function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent =
        now.toLocaleTimeString('en-US', { hour12: false });
    }

    // Update random number
    function updateRandom() {
      document.getElementById('random-value').textContent =
        Math.floor(Math.random() * 10000);
    }

    // Initial updates
    updateTime();
    updateRandom();

    // Update every second
    setInterval(updateTime, 1000);
    setInterval(updateRandom, 1000);

    // Button interaction counter
    let clickCount = 0;
    document.getElementById('transform-button').addEventListener('click', function() {
      clickCount++;
      this.textContent = `Clicked ${clickCount} times`;
    });
  </script>
</body>
</html>
