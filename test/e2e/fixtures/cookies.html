<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cookie Capture Test - Percy Nightwatch E2E</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    header h1 {
      color: #f59e0b;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      color: #f59e0b;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #f59e0b;
    }

    .cookie-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    .cookie-table th {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #7c2d12;
      padding: 15px;
      text-align: left;
      font-weight: bold;
    }

    .cookie-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #f3f4f6;
    }

    .cookie-table tr:last-child td {
      border-bottom: none;
    }

    .cookie-table tr:hover {
      background: #fef3c7;
    }

    .cookie-value {
      font-family: 'Courier New', monospace;
      background: #fef3c7;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .info-box {
      background: #fffbea;
      border-left: 4px solid #f59e0b;
      padding: 20px;
      border-radius: 4px;
      margin: 20px 0;
    }

    .info-box h3 {
      color: #d97706;
      margin-bottom: 10px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
      font-size: 1rem;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #333;
      border: 2px solid #d1d5db;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .cookie-icon {
      font-size: 3rem;
      text-align: center;
      margin: 20px 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #7c2d12;
    }

    .stat-label {
      color: #92400e;
      margin-top: 8px;
      font-size: 1rem;
    }

    .code-block {
      background: #2d3748;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
      margin: 15px 0;
    }

    .feature-list {
      list-style-position: inside;
      line-height: 2;
      color: #555;
    }

    .feature-list li {
      padding-left: 10px;
      border-left: 3px solid #f59e0b;
      margin-bottom: 10px;
      padding-top: 5px;
      padding-bottom: 5px;
      background: #fef3c7;
      border-radius: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="cookie-icon">üç™</div>
      <h1>Cookie Capture Test</h1>
      <p style="font-size: 1.1rem; margin-top: 10px; color: #666;">
        Testing cookie serialization and attachment to Percy snapshots
      </p>
    </header>

    <!-- Info Section -->
    <div class="section">
      <h2>üìã About Cookie Testing</h2>
      <p style="margin-bottom: 15px; line-height: 1.8;">
        Percy Nightwatch SDK automatically captures and attaches browser cookies to every
        DOM snapshot. This ensures that Percy can accurately replay the page state,
        including authentication and session data.
      </p>

      <h3 style="color: #f59e0b; margin: 20px 0 10px 0;">Features Tested:</h3>
      <ul class="feature-list">
        <li><strong>Cookie Capture</strong> - Automatic cookie extraction via browser.getCookies()</li>
        <li><strong>Cookie Attributes</strong> - Domain, path, expires, secure, httpOnly, sameSite</li>
        <li><strong>Multiple Cookies</strong> - Session, preferences, tracking, and custom cookies</li>
        <li><strong>Cookie Attachment</strong> - Cookies included in domSnapshot payload to Percy</li>
        <li><strong>Session Persistence</strong> - Cookies preserved across snapshot captures</li>
      </ul>
    </div>

    <!-- Stats Section -->
    <div class="section">
      <h2>üìä Cookie Statistics</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-cookies">0</div>
          <div class="stat-label">Total Cookies</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="session-cookies">0</div>
          <div class="stat-label">Session Cookies</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="persistent-cookies">0</div>
          <div class="stat-label">Persistent Cookies</div>
        </div>
      </div>
    </div>

    <!-- Cookie Actions -->
    <div class="section">
      <h2>‚öôÔ∏è Cookie Actions</h2>
      <p style="margin-bottom: 20px;">
        Use these buttons to manipulate cookies and test different scenarios:
      </p>

      <div class="button-group">
        <button class="btn btn-primary" onclick="setDefaultCookies()">
          üç™ Set Default Cookies
        </button>
        <button class="btn btn-primary" onclick="setSessionCookie()">
          üìù Add Session Cookie
        </button>
        <button class="btn btn-primary" onclick="setPersistentCookie()">
          ‚è∞ Add Persistent Cookie
        </button>
        <button class="btn btn-primary" onclick="setSecureCookie()">
          üîí Add Secure Cookie
        </button>
        <button class="btn btn-secondary" onclick="displayCookies()">
          üîÑ Refresh Display
        </button>
        <button class="btn btn-danger" onclick="clearAllCookies()">
          üóëÔ∏è Clear All Cookies
        </button>
      </div>
    </div>

    <!-- Cookie Display -->
    <div class="section">
      <h2>üç™ Current Cookies</h2>
      <div id="cookie-display">
        <div class="empty-state">
          No cookies found. Click "Set Default Cookies" to populate.
        </div>
      </div>
    </div>

    <!-- Implementation Details -->
    <div class="section">
      <h2>üîß Implementation Details</h2>

      <div class="info-box">
        <h3>How Cookie Capture Works:</h3>
        <p style="line-height: 1.8; color: #555; margin-top: 10px;">
          The Percy Nightwatch SDK's <code>captureSerializedDOM()</code> function automatically
          calls <code>browser.getCookies()</code> and attaches the cookie array to the
          <code>domSnapshot.cookies</code> property before posting to Percy.
        </p>
      </div>

      <div class="code-block">
// From lib/snapshot.js - Cookie capture implementation
async function captureSerializedDOM(browser, options = {}, utils) {
  let { domSnapshot, url } = await executeScript(browser, function(opts) {
    return {
      domSnapshot: PercyDOM.serialize(opts),
      url: document.URL
    };
  }, [serializeOptions]);

  if (!domSnapshot) domSnapshot = {};

  // Capture and attach cookies
  domSnapshot.cookies = await getCookies(browser);

  return { domSnapshot, url };
}
      </div>

      <div class="info-box" style="margin-top: 20px;">
        <h3>Cookie Attributes Captured:</h3>
        <ul class="feature-list" style="margin-top: 10px;">
          <li><strong>name</strong> - Cookie name identifier</li>
          <li><strong>value</strong> - Cookie value (may be encoded)</li>
          <li><strong>domain</strong> - Domain scope for the cookie</li>
          <li><strong>path</strong> - Path scope for the cookie</li>
          <li><strong>expires</strong> - Expiration timestamp (if persistent)</li>
          <li><strong>secure</strong> - HTTPS-only flag</li>
          <li><strong>httpOnly</strong> - No JavaScript access flag</li>
          <li><strong>sameSite</strong> - CSRF protection (Strict, Lax, None)</li>
        </ul>
      </div>
    </div>

    <!-- Testing Instructions -->
    <div class="section">
      <h2>üß™ Testing Instructions</h2>

      <h3 style="color: #f59e0b; margin: 20px 0 10px 0;">Test Scenarios:</h3>
      <ul class="feature-list">
        <li>Take snapshot with no cookies - verify empty cookies array</li>
        <li>Set default cookies and take snapshot - verify cookies captured</li>
        <li>Add session cookies - verify session cookies included</li>
        <li>Add persistent cookies - verify expiration dates captured</li>
        <li>Add secure cookies - verify secure flag preserved</li>
        <li>Clear cookies and snapshot - verify cookies removed from payload</li>
        <li>Check Percy payload contains cookies in correct format</li>
      </ul>

      <h3 style="color: #f59e0b; margin: 20px 0 10px 0;">Expected Behavior:</h3>
      <ul class="feature-list">
        <li>All cookies visible in browser should be captured</li>
        <li>Cookie attributes should be preserved accurately</li>
        <li>Cookies should be included in every snapshot automatically</li>
        <li>Percy should receive cookies in standard WebDriver format</li>
        <li>HttpOnly cookies may not be visible in document.cookie but should still be captured</li>
      </ul>
    </div>
  </div>

  <script>
    // Set default cookies for testing
    function setDefaultCookies() {
      document.cookie = 'session_id=abc123xyz789; path=/';
      document.cookie = 'user_name=PercyTester; path=/';
      document.cookie = 'theme=dark; path=/';
      document.cookie = 'lang=en-US; path=/';
      displayCookies();
      alert('Default cookies set!');
    }

    // Set a session cookie (no expiration)
    function setSessionCookie() {
      const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
      document.cookie = `${sessionId}=temporary_value; path=/`;
      displayCookies();
      alert(`Session cookie "${sessionId}" added!`);
    }

    // Set a persistent cookie (with expiration)
    function setPersistentCookie() {
      const expires = new Date();
      expires.setDate(expires.getDate() + 365); // 1 year
      const cookieName = 'persistent_' + Math.random().toString(36).substr(2, 5);
      document.cookie = `${cookieName}=long_term_value; expires=${expires.toUTCString()}; path=/`;
      displayCookies();
      alert(`Persistent cookie "${cookieName}" added (expires in 1 year)!`);
    }

    // Set a secure cookie (only works over HTTPS)
    function setSecureCookie() {
      const cookieName = 'secure_' + Math.random().toString(36).substr(2, 5);
      // Note: secure flag only works on HTTPS
      document.cookie = `${cookieName}=secure_value; path=/; secure; samesite=strict`;
      displayCookies();
      alert(`Secure cookie "${cookieName}" added!`);
    }

    // Parse and display all cookies
    function displayCookies() {
      const cookies = document.cookie.split(';').filter(c => c.trim());
      const cookieCount = cookies.length;

      // Update stats
      document.getElementById('total-cookies').textContent = cookieCount;
      document.getElementById('session-cookies').textContent = cookies.filter(c => !c.includes('expires')).length;
      document.getElementById('persistent-cookies').textContent = cookies.filter(c => c.includes('expires')).length;

      // Display cookies in table
      const display = document.getElementById('cookie-display');

      if (cookieCount === 0) {
        display.innerHTML = '<div class="empty-state">No cookies found. Click "Set Default Cookies" to populate.</div>';
        return;
      }

      let html = '<table class="cookie-table">';
      html += '<thead><tr><th>Name</th><th>Value</th><th>Attributes</th></tr></thead>';
      html += '<tbody>';

      cookies.forEach(cookie => {
        const [nameValue, ...attrs] = cookie.trim().split(';');
        const [name, value] = nameValue.split('=');

        html += '<tr>';
        html += `<td><strong>${name.trim()}</strong></td>`;
        html += `<td><span class="cookie-value">${value ? value.trim() : '(empty)'}</span></td>`;
        html += `<td style="font-size: 0.85rem; color: #666;">${attrs.join('; ') || 'Session cookie'}</td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      display.innerHTML = html;
    }

    // Clear all cookies
    function clearAllCookies() {
      const cookies = document.cookie.split(';');
      cookies.forEach(cookie => {
        const name = cookie.split('=')[0].trim();
        // Set expiration to past date to delete
        document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
      });
      displayCookies();
      alert('All cookies cleared!');
    }

    // Initial setup - set default cookies on page load
    setDefaultCookies();

    // Display cookies immediately
    displayCookies();
  </script>
</body>
</html>
